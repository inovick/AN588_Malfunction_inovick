---
title: "Regression_HW_code_final"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Challenge 2

## The dataset from Kamilar and Cooper has in it a large number of variables related to life history and body size. For this exercise, the end aim is to fit a simple linear regression model to predict longevity (MaxLongevity_m) measured in months from species’ brain size (Brain_Size_Species_Mean) measured in grams. Do the following for both longevity~brain size and log(longevity)~log(brain size)

# Install and load packages:
```{r}
#Load necessary packages
library(curl)
library(ggplot2)
library(manipulate)
install.packages("gridExtra")
library(gridExtra)
install.packages("lmodel2")
library(lmodel2)
library(tidyr)
```

#Load data
```{r}
#Load the data using curl command
f <- curl("https://raw.githubusercontent.com/fuzzyatelin/fuzzyatelin.github.io/master/AN588_Fall21/KamilarAndCooperData.csv")
d <- read.csv(f, header = TRUE, sep = ",", stringsAsFactors = FALSE)
head(d)
```

##Fit the regression model and, using {ggplot2}, produce a scatterplot with the fitted line superimposed upon the data. Append the the fitted model equation to your plot (HINT: use the function geom_text()
#I originally did with both lm and another messier way without axes labels and using the code from module 12, determining the slope by hand instead of using lm. I changed to just using the lm function and geom_point.
```{r}
m <- lm(MaxLongevity_m ~ Brain_Size_Species_Mean, data = d)
m
names(m)
m$coefficients

lblm <- ggplot(data = d, aes(x = Brain_Size_Species_Mean, y = MaxLongevity_m))
lblm<- lblm + geom_point() 
lbllm<- lblm + geom_smooth(method = "lm", formula = y ~ x) + xlab("Mean Species Brain Size (g)") + ylab("Max Species Longevity (months)") + theme_classic()
lblm


loglbl<- lm(log(MaxLongevity_m) ~ log(Brain_Size_Species_Mean), data = d)
loglbl

loglblm <- ggplot(data = d, aes(x = log(Brain_Size_Species_Mean), y = log(MaxLongevity_m)))
loglblm<- loglblm + geom_point() 
loglblm<- loglblm + geom_smooth(method = "lm", formula = y ~ x) + xlab("Log Mean Species Brain Size (g)") + ylab("Log Max Species Longevity (months)") + theme_classic()
loglblm
```

##Intercept is 248.952. This means that when the x=0, brain size would be 248.952 g. I am still not completely sure if I am interpreting this correctly, because doesn't that mean that when the organism is 0 years old, its brain is 248.952g? So is this the starting brain size?

#Identify and interpret the point estimate of the slope (β1), as well as the outcome of the test associated with the hypotheses H0: β1 = 0; HA: β1 ≠ 0. Also, find a 90 percent CI for the slope (β1) parameter.
```{r}
summary(lbModel)
ci <- confint(m, level = 0.90)
ci
summary(loglbl)
ci <- confint(loglbl, level = 0.90)
ci

#Log transformed data is a better graph because it cuts out extra and fits it nicely
```

##I found this code on stack exchange to put a legend displaying the equation on the graph. None of my peer commentary group added a legend on their graph, so I may have misinterpreted the directions, but I will leave the code in because it did indeed create a figure legend and I may want to use it later:
```{r}
#Made the variables into a dataframe first
df <- data.frame(x = d$MaxLongevity_m, y = d$Brain_Size_Species_Mean)


lm_eqn <- function(df){
    m <- lm(y ~ x, df);
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}
p1 <- g + geom_text(x = 200, y = 400, label = lm_eqn(df), parse = TRUE)
p1
```

##Using your model, add lines for the 90 percent confidence and prediction interval bands on the plot and add a legend to differentiate between the lines. This didn't work for me but I tried for awhile.
```{r}
pi <- predict(m, newdata = data.frame(longevity = d$MaxLongevity_m), interval = "prediction",
    level = 0.95)  # for a vector of values
head(pi)

df <- cbind(df, pi)
names(df) <- c("CIfit", "CIlwr", "CIupr", "PIfit", "PIlwr",
    "PIupr")
head(df)

g <- g + geom_line(data = df, aes(x = x, y = PIlwr), colour = "red")
g <- g + geom_line(data = df, aes(x = x, y = PIupr), colour = "red")
g

v <- seq(from = 0, to = 2000, by = 100)
m <- lm(data = d,  ~ d$MaxLongevity_m)
ci <- predict(m, newdata = data.frame(MaxLongevity_m = v), interval = "confidence", level = 0.95)
pi <- predict(m, newdata = data.frame(MaxLongevity_m = v), interval = "prediction", level = 0.95)
plot(data = d, MaxLongevity_m ~ Brain_Size_Species_Mean)
lines(x = v, y = ci[, 1], col = "black")
lines(x = v, y = ci[, 2], col = "blue")
lines(x = v, y = ci[, 3], col = "blue")
lines(x = v, y = pi[, 2], col = "red")
lines(x = v, y = pi[, 3], col = "red")
```

## Figuring out the best slope-- identifying the point estimate of the slope
```{r}
slope.test <- function(beta1) {
    g <- ggplot(data = d, aes(x = d$Brain_Size_Species_Mean, y = MaxLongevity_m))
    g <- g + geom_point()
    g <- g + geom_abline(intercept = 0, slope = beta1, size = 1, colour = "blue",
        alpha = 1/2)
    ols <- sum((y - beta1 * x)^2)
    g <- g + ggtitle(paste("Slope = ", beta1, "\nSum of Squared Deviations = ",
        round(ols, 3)))
    g
}
#Using manipulate. It just gives me a gray square again. Why??
manipulate(slope.test(beta1), beta1 = slider(-1, 1, initial = 0, step = 0.005))
```
#Confidence interval
```{r}
ci <- confint(m, level = 0.90) # using the results of lm()
ci
```

#Produce a point estimate and associated 90 percent PI for the longevity of a species whose brain weight is 800 gm. Do you trust the model to predict observations accurately for this value of the explanatory variable? Why or why not?
```{r}
m <- lm(data = d, MaxLongevity_m ~ Brain_Size_Species_Mean)
summary(m)

t <- coef(summary(m))
t <- data.frame(unlist(t))
colnames(t) <- c("Est", "SE", "t", "p")
t

t$calct <- (t$Est - 0)/t$SE
t$calcp <- 2 * pt(t$calct, df = 998, lower.tail = FALSE)  # x2 because is 2-tailed test
t

ci <- confint(m, level = 0.90)  # using the results of lm()
ci
```

```{r}
beta0 <- t$Est[1]
beta1 <- t$Est[2]
h_hat <- beta1 * 800 + beta0
h_hat
```
#1223.345 months. I don't fully trust this estimate because the confidence interval is 90% which leaves 10% up to potential chance, so this may not be completely accurate. Additionally, and this could be due to me doing this incorrectly, the predicted age in years is 101.9 years. While this is all hypothetical, if 800g is a common brain size, it can be assumed that not all primates with an 800g brain are 100 years old.

#I'm going to try again with a different equation and see if my results are the same:
```{r}
pi <- predict(m, newdata = data.frame(Brain_Size_Species_Mean = 800), interval = "prediction", level = 0.90)
pi

```
#It is the same, so I am probably doing it correctly. I hope. So this may not be a totally trusted way of predicting. I will try again and adjust the confidence interval to see if anything significantly changes:
```{r}
pi <- predict(m, newdata = data.frame(Brain_Size_Species_Mean = 800), interval = "prediction", level = 0.99)
pi
```
#Not a lot of difference. So maybe the predictions can be trusted and we are just theoretically predicting something far in the future that may not ever be realistic.